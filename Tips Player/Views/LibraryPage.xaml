<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Tips_Player.ViewModels"
             xmlns:models="clr-namespace:Tips_Player.Models"
             xmlns:helpers="clr-namespace:Tips_Player.Helpers"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"
             x:Class="Tips_Player.Views.LibraryPage"
             x:DataType="viewmodels:LibraryViewModel"
             Style="{StaticResource PlayerPageStyle}"
             ios:Page.SafeAreaEdges="All"
             Shell.NavBarIsVisible="False">

    <Grid RowDefinitions="Auto,*">

        <!-- Header -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Padding="24,40,24,16">
            <HorizontalStackLayout Grid.Column="0" Spacing="12" VerticalOptions="Center">
                <Image Source="app_logo.png" HeightRequest="32" WidthRequest="32" VerticalOptions="Center"/>
                <Label Text="Library" Style="{StaticResource PageTitleStyle}" VerticalOptions="Center"/>
            </HorizontalStackLayout>
            <Button Grid.Column="1"
                    Text="{x:Static helpers:FontIcons.Plus}"
                    FontFamily="FontAwesome"
                    Command="{Binding AddFilesCommand}"
                    BackgroundColor="{StaticResource CardBackground}"
                    TextColor="{StaticResource TextPrimary}"
                    FontSize="20"
                    HeightRequest="44"
                    WidthRequest="44"
                    CornerRadius="22"
                    Padding="0"/>
        </Grid>

        <!-- Content -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="16,0,16,24" Spacing="16">

                <!-- Category Cards Grid -->
                <Label Text="Browse" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" Margin="8,0,0,4"/>

                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="12">

                    <!-- Songs Card -->
                    <Border Grid.Row="0" Grid.Column="0" Background="{StaticResource CardBackground}"
                           Stroke="Transparent" StrokeShape="RoundRectangle 16" Padding="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateToSongsCommand}"/>
                        </Border.GestureRecognizers>
                        <Grid RowDefinitions="*,Auto" HeightRequest="120">
                            <Grid Grid.Row="0" BackgroundColor="#1a6366F1" Padding="16">
                                <Label Text="{x:Static helpers:FontIcons.Music}"
                                       FontFamily="FontAwesome"
                                       FontSize="36"
                                       TextColor="{StaticResource AccentColor}"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"/>
                            </Grid>
                            <VerticalStackLayout Grid.Row="1" Padding="12,8" Spacing="2">
                                <Label Text="Songs" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                <Label FontSize="12" TextColor="{StaticResource TextMuted}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding SongsCount}"/>
                                            <Span Text=" tracks"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </VerticalStackLayout>
                        </Grid>
                    </Border>

                    <!-- Videos Card -->
                    <Border Grid.Row="0" Grid.Column="1" Background="{StaticResource CardBackground}"
                           Stroke="Transparent" StrokeShape="RoundRectangle 16" Padding="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateToVideosCommand}"/>
                        </Border.GestureRecognizers>
                        <Grid RowDefinitions="*,Auto" HeightRequest="120">
                            <Grid Grid.Row="0" BackgroundColor="#1aF472B6" Padding="16">
                                <Label Text="{x:Static helpers:FontIcons.Video}"
                                       FontFamily="FontAwesome"
                                       FontSize="36"
                                       TextColor="#F472B6"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"/>
                            </Grid>
                            <VerticalStackLayout Grid.Row="1" Padding="12,8" Spacing="2">
                                <Label Text="Videos" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                <Label FontSize="12" TextColor="{StaticResource TextMuted}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding VideosCount}"/>
                                            <Span Text=" videos"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </VerticalStackLayout>
                        </Grid>
                    </Border>

                    <!-- Artists Card -->
                    <Border Grid.Row="1" Grid.Column="0" Background="{StaticResource CardBackground}"
                           Stroke="Transparent" StrokeShape="RoundRectangle 16" Padding="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateToArtistsCommand}"/>
                        </Border.GestureRecognizers>
                        <Grid RowDefinitions="*,Auto" HeightRequest="120">
                            <Grid Grid.Row="0" BackgroundColor="#1a22D3EE" Padding="16">
                                <Label Text="{x:Static helpers:FontIcons.Artist}"
                                       FontFamily="FontAwesome"
                                       FontSize="36"
                                       TextColor="#22D3EE"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"/>
                            </Grid>
                            <VerticalStackLayout Grid.Row="1" Padding="12,8" Spacing="2">
                                <Label Text="Artists" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                <Label FontSize="12" TextColor="{StaticResource TextMuted}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding ArtistsCount}"/>
                                            <Span Text=" artists"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </VerticalStackLayout>
                        </Grid>
                    </Border>

                    <!-- Albums Card -->
                    <Border Grid.Row="1" Grid.Column="1" Background="{StaticResource CardBackground}"
                           Stroke="Transparent" StrokeShape="RoundRectangle 16" Padding="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateToAlbumsCommand}"/>
                        </Border.GestureRecognizers>
                        <Grid RowDefinitions="*,Auto" HeightRequest="120">
                            <Grid Grid.Row="0" BackgroundColor="#1aA78BFA" Padding="16">
                                <Label Text="{x:Static helpers:FontIcons.Album}"
                                       FontFamily="FontAwesome"
                                       FontSize="36"
                                       TextColor="#A78BFA"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"/>
                            </Grid>
                            <VerticalStackLayout Grid.Row="1" Padding="12,8" Spacing="2">
                                <Label Text="Albums" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                <Label FontSize="12" TextColor="{StaticResource TextMuted}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding AlbumsCount}"/>
                                            <Span Text=" albums"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </VerticalStackLayout>
                        </Grid>
                    </Border>

                    <!-- Playlists Card -->
                    <Border Grid.Row="2" Grid.Column="0" Background="{StaticResource CardBackground}"
                           Stroke="Transparent" StrokeShape="RoundRectangle 16" Padding="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateToPlaylistsCommand}"/>
                        </Border.GestureRecognizers>
                        <Grid RowDefinitions="*,Auto" HeightRequest="120">
                            <Grid Grid.Row="0" BackgroundColor="#1aFBBF24" Padding="16">
                                <Label Text="{x:Static helpers:FontIcons.Playlist}"
                                       FontFamily="FontAwesome"
                                       FontSize="36"
                                       TextColor="#FBBF24"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"/>
                            </Grid>
                            <VerticalStackLayout Grid.Row="1" Padding="12,8" Spacing="2">
                                <Label Text="Playlists" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                <Label FontSize="12" TextColor="{StaticResource TextMuted}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding PlaylistsCount}"/>
                                            <Span Text=" playlists"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </VerticalStackLayout>
                        </Grid>
                    </Border>

                    <!-- Folders Card -->
                    <Border Grid.Row="2" Grid.Column="1" Background="{StaticResource CardBackground}"
                           Stroke="Transparent" StrokeShape="RoundRectangle 16" Padding="0">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateToFoldersCommand}"/>
                        </Border.GestureRecognizers>
                        <Grid RowDefinitions="*,Auto" HeightRequest="120">
                            <Grid Grid.Row="0" BackgroundColor="#1a4ADE80" Padding="16">
                                <Label Text="{x:Static helpers:FontIcons.Folder}"
                                       FontFamily="FontAwesome"
                                       FontSize="36"
                                       TextColor="#4ADE80"
                                       VerticalOptions="Center"
                                       HorizontalOptions="Center"/>
                            </Grid>
                            <VerticalStackLayout Grid.Row="1" Padding="12,8" Spacing="2">
                                <Label Text="Folders" FontSize="14" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                <Label FontSize="12" TextColor="{StaticResource TextMuted}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding FoldersCount}"/>
                                            <Span Text=" folders"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </VerticalStackLayout>
                        </Grid>
                    </Border>

                </Grid>

                <!-- Recently Played Section -->
                <VerticalStackLayout Spacing="8" Margin="0,8,0,0"
                                     IsVisible="{Binding RecentItems.Count, Converter={StaticResource IsNotNullConverter}}">
                    <Label Text="Recently Played" FontSize="18" FontAttributes="Bold"
                           TextColor="{StaticResource TextPrimary}" Margin="8,0,0,4"/>

                    <CollectionView ItemsSource="{Binding RecentItems}" SelectionMode="None" HeightRequest="180">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="12"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:MediaItem">
                                <Border Background="{StaticResource CardBackground}"
                                       Stroke="Transparent" StrokeShape="RoundRectangle 12" Padding="0"
                                       WidthRequest="130">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:LibraryViewModel}}, Path=PlayItemCommand}"
                                                              CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                    <Grid RowDefinitions="*,Auto">
                                        <Border Grid.Row="0" Background="{StaticResource SurfaceBackground}"
                                               StrokeShape="RoundRectangle 12,12,0,0" Stroke="Transparent" Padding="0" HeightRequest="100">
                                            <Label Text="{Binding MediaType, Converter={StaticResource MediaTypeToIconConverter}}"
                                                   FontFamily="FontAwesome" FontSize="32"
                                                   TextColor="{StaticResource AccentColor}"
                                                   HorizontalOptions="Center" VerticalOptions="Center"/>
                                        </Border>
                                        <VerticalStackLayout Grid.Row="1" Padding="8" Spacing="2">
                                            <Label Text="{Binding Title}" FontSize="12" FontAttributes="Bold"
                                                   TextColor="{StaticResource TextPrimary}"
                                                   LineBreakMode="TailTruncation" MaxLines="1"/>
                                            <Label Text="{Binding Artist}" FontSize="10"
                                                   TextColor="{StaticResource TextMuted}"
                                                   LineBreakMode="TailTruncation" MaxLines="1"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Empty State -->
                <VerticalStackLayout IsVisible="{Binding HasItems, Converter={StaticResource InverseBoolConverter}}"
                                     VerticalOptions="Center" HorizontalOptions="Center"
                                     Spacing="16" Padding="40" Margin="0,40,0,0">
                    <Label Text="{x:Static helpers:FontIcons.Music}"
                           FontFamily="FontAwesome"
                           FontSize="60"
                           TextColor="{StaticResource TextMuted}"
                           HorizontalOptions="Center"/>
                    <Label Text="Your library is empty"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="{StaticResource TextPrimary}"
                           HorizontalTextAlignment="Center"/>
                    <Label Text="Add some music and videos to get started"
                           FontSize="14"
                           TextColor="{StaticResource TextMuted}"
                           HorizontalTextAlignment="Center"/>
                    <Button Text="Add Files"
                            Command="{Binding AddFilesCommand}"
                            BackgroundColor="{StaticResource AccentColor}"
                            TextColor="{StaticResource TextPrimary}"
                            FontSize="16"
                            HeightRequest="48"
                            CornerRadius="24"
                            Padding="32,0"
                            Margin="0,8,0,0"/>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

    </Grid>

</ContentPage>
